<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ - ØºÙŠÙ‘Ø±Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_APP.firebaseapp.com",
    projectId: "YOUR_APP",
    storageBucket: "YOUR_APP.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();
  const dbFB = firebase.firestore();
</script>
<script>
let db = { fabrics: [], ready: [] };
let tempImg = "", receiptImg = "";
let readyCartTotal = 0;
let adminMode = false;

// -- Ø¨ÙˆØª ÙŠØ§Ù‚ÙˆØª ÙˆØ¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ…Ø§ Ø§Ù„Ø³Ø§Ø¨Ù‚ --

function toggleYaqoot() { const chat = document.getElementById('yaqoot_chat'); chat.style.display = chat.style.display === 'block' ? 'none' : 'block'; }
function yaqootReply(type) {
    const text = document.getElementById('chat_text');
    if(type === 'policy') text.innerHTML = "<b>ğŸ›¡ï¸ Ø¶Ù…Ø§Ù† Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ:</b> Ù†Ø¶Ù…Ù† Ù„Ùƒ Ø§Ù„Ù…Ù‚Ø§Ø³ 100%. Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø£ÙŠ Ø§Ø®ØªÙ„Ø§ÙØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø¬Ø§Ù†ÙŠ.";
    else if(type === 'offer') text.innerHTML = "<b>ğŸ Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ø´:</b> Ø¹Ù†Ø¯ Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù‚Ø¯Ù…Ø§Ù‹ØŒ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ (ØªØ·Ø±ÙŠØ² ÙŠØ¯ÙˆÙŠ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø±Ù‚Ø¨Ø©) Ø£Ùˆ (Ø¹Ù„Ø¨Ø© ÙƒØ¨ÙƒØ§Øª).";
    else if(type === 'about') text.innerHTML = "<b>ğŸ“œ Ù‚ØµØ© Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ:</b> Ø¨Ø¯Ø£Øª Ø±Ø­Ù„ØªÙ†Ø§ ÙÙŠ 2002 Ø¹Ù„Ù‰ ÙŠØ¯ Ø§Ù„ÙˆØ§Ù„Ø¯ Ø§Ù„Ù…Ø¤Ø³Ø³.";
}

// -- Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© --
function openAdmin() {
    if(prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:") === "1234") {
        adminMode = true;
        document.getElementById('adminPanel').style.display='flex';
        filterReady('all');
    }
}
function closeAdmin() {
    adminMode = false;
    document.getElementById('adminPanel').style.display='none';
    filterReady('all');
}

// Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Firebase ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø·
function encodeImg(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    const storageRef = storage.ref('products/' + Date.now() + '_' + file.name);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed', 
      null,
      (error) => { alert('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©'); }, 
      () => {
        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
          tempImg = downloadURL;
          alert("ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.");
        });
      }
    );
}
function encodeReceipt(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = (e) => receiptImg = e.target.result;
    reader.readAsDataURL(file);
}

function saveProduct() {
    const cat = document.getElementById('adm_cat').value;
    const title = document.getElementById('adm_title').value;
    const newP = document.getElementById('adm_new').value;

    if(cat === "logo") {
        document.getElementById('store_logo').src = tempImg;
        closeAdmin();
        alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±Ø›");
    } else if(!tempImg || !title || !newP) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©.");
    } else {
        const docCat = (cat === "fabric") ? "fabrics" : "ready";
        const item = { cat, title, newPrice: newP, img: tempImg };
        dbFB.collection(docCat).add(item).then(() => {
            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
            loadProducts(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            closeAdmin();
        });
    }
}

function deleteProduct(id, cat) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
    dbFB.collection(cat).doc(id).delete()
        .then(() => {
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.");
            loadProducts();
        })
        .catch(() => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù."));
}

// -- Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† ÙØ§ÙŠÙŠØ±Ø¨ÙŠØ² --
function loadProducts() {
    db.fabrics = [];
    db.ready = [];
    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ù…Ø´Ø©
    dbFB.collection('fabrics').get().then((qs) => {
        db.fabrics = [];
        qs.forEach((doc) => {
            let p = doc.data();
            p.id = doc.id;
            db.fabrics.push(p);
        });
    });
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
    dbFB.collection('ready').get().then((qs) => {
        db.ready = [];
        qs.forEach((doc) => {
            let p = doc.data();
            p.id = doc.id;
            db.ready.push(p);
        });
        filterReady('all');
    });
}

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = function() {
    loadProducts();
}

// -- ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ù…Ø§Ø´ --
function openFabricModal() {
    const list = document.getElementById('modal_fabric_list');
    list.innerHTML = db.fabrics.length ? db.fabrics.map(f => `
        <div style="border:1px solid #eee; padding:8px; text-align:center; cursor:pointer; border-radius:12px; transition:0.3s;" onclick="confirmFabricSelection('${f.title}', ${f.newPrice}, '${f.img}')">
            <img src="${f.img}" style="width:100%; height:80px; object-fit:cover; border-radius:8px;">
            <div style="font-size:11px; font-weight:bold; margin-top:5px;">${f.title}</div>
            <div style="font-size:11px; color:green;">${f.newPrice} Ø±ÙŠØ§Ù„</div>
        </div>
    `).join('') : '<p style="grid-column:1/-1; text-align:center;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ù…Ø´Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹</p>';
    document.getElementById('fabricModal').style.display = 'flex';
}

function confirmFabricSelection(name, price, img) {
    const id = Date.now();
    const card = document.createElement('div');
    card.className = 'selected-thobe-card';
    card.id = `thobe_${id}`;
    card.innerHTML = `
        <button type="button" class="remove-card" onclick="removeThobe(${id})">Ã—</button>
        <div style="display:flex; gap:12px; align-items:center;">
            <img src="${img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover; border:1px solid var(--gold);">
            <div><b>Ø«ÙˆØ¨: ${name}</b><br><span style="color:green; font-size:13px;">${price} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</span></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:15px;">
            <select class="thobe-opt"><option>Ù‚Ù„Ø§Ø¨ Ù…Ù„ÙƒÙŠ</option><option>Ù‚Ù„Ø§Ø¨ ÙØ±Ù†Ø³ÙŠ</option><option>ØµÙŠÙ†ÙŠ</option><option>Ø³Ø§Ø¯Ø© Ù…Ø±Ø¨Ø¹</option></select>
            <select class="thobe-opt"><option>ÙƒØ¨Ùƒ Ù‚Ù…Ø§Ø´</option><option>ÙƒØ¨Ùƒ Ø­Ø´Ùˆ</option><option>Ø³Ø§Ø¯Ø©</option></select>
            <select class="thobe-opt"><option>ÙƒØ¨Ø³ Ø¸Ø§Ù‡Ø±</option><option>Ø²Ø±Ø§Ø± Ù…Ø®ÙÙŠ</option><option>Ø³Ø­Ø§Ø¨ VIP</option></select>
            <select class="thobe-opt"><option>Ù‚ØµØ© Ù‚Ø·Ø±ÙŠØ©</option><option>Ù‚ØµØ© Ø³Ø¹ÙˆØ¯ÙŠØ©</option><option>Ù‚ØµØ© ÙƒÙˆÙŠØªÙŠØ©</option></select>
        </div>
        <input type="hidden" class="item-price" value="${price}">
    `;
    document.getElementById('tailor_list').appendChild(card);
    calcGrandTotal();
    document.getElementById('fabricModal').style.display = 'none';
}

function removeThobe(id) { document.getElementById(`thobe_${id}`).remove(); calcGrandTotal(); }

// -- Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© --
function addReadyToCart(price) {
    readyCartTotal += parseInt(price);
    calcGrandTotal();
    alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù‡ÙŠØ¨ØªÙƒ");
}

// -- Ø§Ù„Ù…ÙØ¶Ù„Ø© --
function addToFavorite(id) {
    let favorites = JSON.parse(localStorage.getItem('ymk_favorites') || "[]");
    if (!favorites.includes(id)) {
        favorites.push(id);
        localStorage.setItem('ymk_favorites', JSON.stringify(favorites));
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
        filterReady('all');
    } else {
        alert("Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
    }
}

function showFavorites() {
    let favorites = JSON.parse(localStorage.getItem('ymk_favorites') || "[]");
    const favItems = db.ready.filter(i => favorites.includes(i.id));
    displayReadyProducts(favItems);
}

function filterReady(type, btn) {
    if(btn) {
        document.querySelectorAll('.ready-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    const items = type === 'all' ? db.ready : db.ready.filter(i => i.cat === type);
    displayReadyProducts(items);
}

// -- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø­Ø°Ù/Ø³Ù„Ø©/Ù‚Ù„Ø¨ Ù…ÙØ¶Ù„Ø© --
function displayReadyProducts(items) {
    const display = document.getElementById('ready_display');
    let favorites = JSON.parse(localStorage.getItem('ymk_favorites') || "[]");
    display.innerHTML =
        items.length ?
            items.map(i => `
                <div class="product-card">
                    <img src="${i.img}">
                    <div style="padding:10px; position:relative;">
                        <div style="font-size:13px; font-weight:bold;">${i.title}</div>
                        <span class="new-price">${i.newPrice} Ø±ÙŠØ§Ù„</span>
                        <button onclick="addReadyToCart('${i.newPrice}')" title="Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡" style="background:none;border:none;cursor:pointer;font-size:19px;color:#28a745;">ğŸ›’</button>
                        <button onclick="addToFavorite('${i.id}')" title="Ø§Ù„Ù…ÙØ¶Ù„Ø©" style="background:none;border:none;cursor:pointer;font-size:19px;color:${favorites.includes(i.id)?'#d2346e':'#bbb'};">&#9829;</button>
                        ${adminMode ? `<button onclick="deleteProduct('${i.id}','ready')" title="Ø­Ø°Ù" style="background:none;border:none;cursor:pointer;position:absolute;top:5px;left:5px;color:#ff4444;font-size:16px;">ğŸ—‘ï¸</button>` : ""}
                    </div>
                </div>
            `).join('')
            : '<p style="grid-column:1/-1; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>';
}

function calcGrandTotal() {
    let t = readyCartTotal;
    document.querySelectorAll('.item-price').forEach(i => t += parseInt(i.value || 0));
    document.getElementById('final_total').innerText = t.toLocaleString();
}

function selectPayment(m, d, el) {
    document.querySelectorAll('.pay-card-ui').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('account_display').style.display = 'block';
    document.getElementById('account_number').innerText = d;
    document.getElementById('selected_payment').value = m + " (" + d + ")";
    document.getElementById('receipt_section').style.display = 'block';
}

// -- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø¯ÙŠÙƒ) --
function submitOrder() {
    const name = document.getElementById('c_name').value;
    const total = document.getElementById('final_total').innerText;
    if (!name || total === "0") return alert("Ø£ÙƒÙ…Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø®ØªØ± Ø«ÙˆØ¨Ø§Ù‹ ÙŠÙ„ÙŠÙ‚ Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹");

    const orderData = {
        name: name,
        phone: document.getElementById('c_phone').value,
        total: total,
        payment: document.getElementById('selected_payment').value,
        date: new Date().toLocaleString('ar-YE'),
        source: "Ù…ØªØ¬Ø± Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ Ø§Ù„Ø­Ø¯ÙŠØ« 2026"
    };

    const webhookUrl = 'https://ali991278.app.n8n.cloud/webhook-test/e4bcc169-93c0-42c5-8226-528f3c6a72e3';
    fetch(webhookUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
    })
    .then(() => {
        alert("Ø§ÙƒØªÙ…Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.\n\nØ³Ù†ØµÙ†Ø¹ Ø£Ù†Ø§Ù‚ØªÙƒ ÙÙŠ Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ Ù„Ù„Ø®ÙŠØ§Ø·Ø© Ø¨Ø¯Ù‚Ø© ØªÙ„ÙŠÙ‚ Ø¨Ùƒ.");
        location.reload();
    })
    .catch(() => alert("ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø·Ù„Ø¨Ùƒ.. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ"));
}
    </script>
